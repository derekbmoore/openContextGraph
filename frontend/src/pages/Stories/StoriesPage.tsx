import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { listStories, API_BASE_URL } from '../../services/api';
import './StoriesPage.css';

interface StoryItem {
    story_id: string;
    topic: string;
    created_at: string;
    story_path: string;
    image_path?: string;
    architecture_image_path?: string;
}

export function StoriesPage() {
    const navigate = useNavigate();
    const [stories, setStories] = useState<StoryItem[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        const fetchStories = async () => {
            try {
                const data = await listStories();
                // Collapse duplicates by normalized topic, keep newest by created_at
                const byTopic = new Map<string, StoryItem>();
                for (const item of data) {
                    const key = (item.topic || '').trim().toLowerCase();
                    const existing = byTopic.get(key);
                    if (!existing) {
                        byTopic.set(key, item);
                        continue;
                    }
                    if (new Date(item.created_at).getTime() > new Date(existing.created_at).getTime()) {
                        byTopic.set(key, item);
                    }
                }
                setStories(Array.from(byTopic.values()));
            } catch (err: any) {
                setError(err.message || 'Failed to load stories');
            } finally {
                setLoading(false);
            }
        };

        fetchStories();
    }, []);

    const getFullImageUrl = (path: string) => {
        if (!path) return '';
        if (path.startsWith('http')) return path;
        return `${API_BASE_URL}${path}`;
    };

    if (loading) return <div className="column column-center"><div className="stories-loading">Loading artifacts...</div></div>;
    if (error) return <div className="column column-center"><div className="stories-error">Error: {error}</div></div>;

    return (
        <div className="column column-center">
            <div className="stories-page">
                <header className="stories-header">
                    <h1>Sage's Artifacts</h1>
                    <p className="subtitle">Collaborative stories and architectural diagrams generated by Sage Meridian.</p>
                </header>

                <div className="stories-grid">
                    {stories.map(story => (
                        <div
                            key={story.story_id}
                            className="story-card"
                            onClick={() => navigate(`/stories/${story.story_id}`)}
                        >
                            <div className="story-icon">
                                {(story.image_path || story.architecture_image_path) ? (
                                    <img
                                        src={getFullImageUrl(story.image_path || story.architecture_image_path || '')}
                                        alt=""
                                        className="story-thumbnail-image"
                                    />
                                ) : (
                                    "ðŸ“œ"
                                )}
                            </div>
                            <div className="story-content">
                                <h3>{story.topic}</h3>
                                <span className="story-date">
                                    {new Date(story.created_at).toLocaleDateString()}
                                </span>
                            </div>
                            <div className="story-arrow">â†’</div>
                        </div>
                    ))}

                    {stories.length === 0 && (
                        <div className="no-stories">
                            No artifacts found. Ask Sage to "create a story" to generate some!
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
